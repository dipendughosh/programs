
#include<stdio.h>
#include<conio.h>
#include<math.h>

int x=0,y=0,g,p; 

int gen_no(int,int,int);
void attacker();
void user_a();
void user_b();

void main()
{	
    int ch;
	clrscr();


	//prime number(p)
    printf("\nEnter a prime number :- ");
    scanf("%d",&p);
    //generator(g)
    printf("\nEnter a generator :- ");
    scanf("%d",&g);
	
    printf("\nPrime number p = %d",p);
    printf("\nGenerator g = %d",g);
	
	printf("\n\nDEFFIE-HELLMAN KEY EXCHANGE:-");
	printf("\n1. Normal Exchange of key.");
	printf("\n2. Key Exchange infilterated by attacker.");
	printf("\nEnter your choice (1 or 2):");
	scanf("%d",&ch);
	switch(ch)
	{
		case 1:
			user_a();
			break;
		case 2:
			attacker();
			break;
		default:
			printf("Invalid Choice!");
			break;
	}		 
    getch();

}

int gen_no(int g,int p,int x)
{
    int r;
	int z = pow(g,x);
    
    if(g!=1)
		r = z % p;
	else
		r=1;
   
    return(r);
}

void attacker()
{
	int c,d,sa,sb;
	
	//For User A
	printf("\nEnter the 1st private key for attacker:");
	scanf("%d",&c);
	
	//For User B
	printf("\nEnter the 2nd private key for attacker:");
	scanf("%d",&d);
	
	//Generating Public Key to be transmitted to User A
	y=gen_no(g,p,c);
	user_a();
	
	//Calculating common private key between User A and Attacker
	sa= gen_no(x,p,c);
	printf("\nCommon Private Key as calculated for User A by Attacker: %d",sa);
	
	//Generating Public Key to be transmitted to User B
	x=gen_no(g,p,d);
	user_b();
	
	//Calculating common private key between User B and Attacker
	sb=gen_no(y,p,d);
	printf("\nCommon Private Key as calculated for User B by Attacker: %d",sb);
}	
	
void user_a()
{
    int a,sa;
        
    //a
    printf("\nEnter user A's private key :- ");
    scanf("%d",&a);
    
    //public key for user A
	x = gen_no(g,p,a);
	printf("\nPublic key for User A: %d",x);
	
	//start actions of User B
	if(y==0)
		user_b();
	
	//private key for both the users
	sa = gen_no(y,p,a);
	printf("\nCommon Private Key as calculated by User A: %d",sa);

}

void user_b()
{
    int b,sb;
        
    //b
    printf("\nEnter user B's private key :- ");
    scanf("%d",&b);
    
    //public key for user A
	y = gen_no(g,p,b);
	printf("\nPublic key for User B: %d",y);
	
	//start actions of User A
	//if(x==0)
		//user_a();
		
	//private key for both the users
	sb = gen_no(x,p,b);
	printf("\nCommon Private Key as calculated by User B: %d",sb);
}